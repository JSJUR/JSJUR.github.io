local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Camera = workspace.CurrentCamera

local LocalPlayer = Players.LocalPlayer
local Aimlock = false
local AimlockKey = Enum.KeyCode.Q
local Balls = {}
local CurrentBallIndex = 1

local function createBallForPlayer(player)
	local function onCharacterAdded(character)
		if player == LocalPlayer then return end

		local HumanoidRootPart = character:WaitForChild("HumanoidRootPart")
		local Humanoid = character:WaitForChild("Humanoid")

		local Ball = Instance.new("Part", workspace)
		Ball.Size = Vector3.new(0.5, 0.5, 0.5)
		Ball.Shape = Enum.PartType.Ball
		Ball.Material = Enum.Material.Neon
		Ball.BrickColor = BrickColor.new("Bright blue")
		Ball.Anchored = true
		Ball.CanCollide = false
		Ball.Name = player.Name .. "'s Ball"

		table.insert(Balls, Ball)

		local Highlight = Instance.new("Highlight", Ball)
		Highlight.FillTransparency = 1
		Highlight.OutlineTransparency = 0.5

		local Jumping = false

		Humanoid.StateChanged:Connect(function(_, NewState)
			if NewState == Enum.HumanoidStateType.Jumping or NewState == Enum.HumanoidStateType.Freefall then
				Jumping = true
			else
				Jumping = false
			end
		end)

		local function UpdateBallPosition()
			local MoveDirection = Humanoid.MoveDirection
			local CameraDirection = Camera.CFrame.LookVector
			local CombinedDirection = MoveDirection * Vector3.new(1, 0, 1) + Vector3.new(0, MoveDirection.Y, 0)

			local NewPosition

			if Jumping then
				NewPosition = HumanoidRootPart.Position + Vector3.new(0, 2, 0) + CombinedDirection * 2
			elseif CombinedDirection.Magnitude > 0 then
				CombinedDirection = CombinedDirection.Unit
				NewPosition = HumanoidRootPart.Position + CombinedDirection * 2
			else
				NewPosition = HumanoidRootPart.Position
			end

			if NewPosition then
				TweenService:Create(Ball, TweenInfo.new(0.05), {Position = NewPosition}):Play()
			end
		end

		RunService.RenderStepped:Connect(UpdateBallPosition)
	end

	player.CharacterAdded:Connect(onCharacterAdded)
	if player.Character then
		onCharacterAdded(player.Character)
	end
end

for _, player in pairs(Players:GetPlayers()) do
	createBallForPlayer(player)
end

Players.PlayerAdded:Connect(createBallForPlayer)

UserInputService.InputBegan:Connect(function(Input, Typing)
	if not Typing and Input.KeyCode == AimlockKey then
		Aimlock = not Aimlock
		if Aimlock then
			CurrentBallIndex = (CurrentBallIndex % #Balls) + 1
		end
	end
end)

RunService.RenderStepped:Connect(function()
	if Aimlock and #Balls > 0 then
		local Ball = Balls[CurrentBallIndex]
		if Ball then
			Camera.CFrame = CFrame.new(Camera.CFrame.Position, Ball.Position)
		end
	end
end)
